<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getStorage, ref, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
      authDomain: "clicon-oficial.firebaseapp.com",
      projectId: "clicon-oficial",
      storageBucket: "clicon-oficial",
      messagingSenderId: "604078149403",
      appId: "1:604078149403:web:5da069e8254c3695028dbe"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    async function cargarClientes() {
      const carpetaRef = ref(storage, "sanvicenteautomotores/historial_cartera");

      try {
        const listado = await listAll(carpetaRef);
        const archivos = listado.items;

        if (archivos.length === 0) throw new Error("No hay archivos en la carpeta");

        // Obtener metadatos para saber cuál es el último subido
        const metas = await Promise.all(archivos.map(a => a.getMetadata()));
        const indexMasReciente = metas.reduce((maxIdx, meta, idx, arr) => {
          return new Date(meta.updated) > new Date(arr[maxIdx].updated) ? idx : maxIdx;
        }, 0);
        const ultimo = archivos[indexMasReciente];
        const url = await getDownloadURL(ultimo);

        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const datos = XLSX.utils.sheet_to_json(hoja);

        const contenedor = document.getElementById("clientes");
        contenedor.innerHTML = "";
        datos.forEach(cliente => {
          const tarjeta = document.createElement("div");
          tarjeta.className = "tarjeta";
          tarjeta.innerHTML = `
            <h3>${cliente.NOMBRE_SUSCRIPTOR || "Sin nombre"}</h3>
            <p>📞 Tel: ${cliente.TELEFONO_SUSCRIPTOR || "-"}</p>
            <p>🧑‍💼 Vendedor: ${cliente.VENDEDOR || "-"}</p>
            <p>📈 Avance: ${cliente.ULT_CUOTA_EMITIDA || "-"}</p>
            <p>💸 Pagas: ${cliente.CANT_CUOTAS_PAGAS || 0}</p>
            <p>⛔ Deuda: ${cliente.NRO_CUOTAS_IMPAGAS || 0}</p>
            <p>📧 Email: ${cliente.Mail || "-"}</p>
            <p>📋 Estado: ${cliente.ESTADO_CONTRATO || "-"}</p>
            <p>📦 G-O: ${cliente.CONTRATO || "-"}</p>
            <p>📝 Suscripción: ${cliente.SUSCRIPCION || "-"}</p>
          `;
          contenedor.appendChild(tarjeta);
        });

      } catch (error) {
        console.error("Error al cargar la cartera:", error);
        alert("No se pudo cargar la cartera.");
      }
    }

    window.onload = cargarClientes;
  </script>
  <style>
    body {
      background-color: #F8FBFF;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      padding: 30px;
    }
    h2 {
      font-size: 26px;
      color: #3399FF;
      margin-bottom: 25px;
    }
    .tarjeta {
      background: white;
      border: 1px solid #D0E3FF;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 16px;
      width: 270px;
      display: inline-block;
      vertical-align: top;
      margin-right: 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Clientes</h2>
  <div id="clientes"></div>
</body>
</html>
