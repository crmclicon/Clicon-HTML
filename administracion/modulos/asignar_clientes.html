<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Asignar Clientes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #F8FBFF;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
      color: #3399FF; /* 🔵 Azul CliCon */
    }
    .buscador {
      margin-bottom: 20px;
    }
    input[type="text"] {
      padding: 8px;
      width: 300px;
    }
    .tabla-clientes {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
    }
    .tabla-clientes th, .tabla-clientes td {
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      text-align: left;
    }
    .tabla-clientes th {
      background-color: #f0f4f8;
    }
    .selector-usuario {
      padding: 6px;
      width: 100%;
    }
    .btn-actualizar {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #3399FF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .mensaje-final {
      margin-top: 20px;
      padding: 10px;
      background-color: #e7f5e6;
      border-left: 4px solid #34a853;
      color: #2b662e;
      display: none;
    }
  </style>
</head>
<body>

  <h2>Asignar clientes sin vendedor</h2>

  <!-- 🔍 Buscador -->
  <div class="buscador">
    <input type="text" id="buscador" placeholder="Buscar por nombre o solicitud">
  </div>

  <!-- 📋 Tabla -->
  <table class="tabla-clientes" id="tablaClientes">
    <thead>
      <tr>
        <th>✔</th>
        <th>Nombre</th>
        <th>Grupo y orden</th>
        <th>Solicitud</th>
        <th>Asignar a</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ✅ Botón -->
  <button class="btn-actualizar" onclick="actualizarCartera()">Actualizar cartera</button>

  <!-- ✅ Mensaje final -->
  <div class="mensaje-final" id="mensajeFinal"></div>

  <!-- 📦 Lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getStorage, ref, listAll, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

    const firebaseConfig = {
      apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
      authDomain: "clicon-oficial.firebaseapp.com",
      projectId: "clicon-oficial",
      storageBucket: "clicon-oficial.appspot.com",
      messagingSenderId: "604078149403",
      appId: "1:604078149403:web:5da069e8254c3695028dbe"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    let listaUsuarios = [];
    let clientesOriginales = [];
    let clientesSinVendedor = [];
    let archivoOriginal;

    // 🔁 Al cargar
    window.addEventListener("DOMContentLoaded", async () => {
      await cargarUsuarios();
      await leerUltimaCartera();
    });

    // 🔄 Cargar usuarios válidos
    async function cargarUsuarios() {
      const querySnapshot = await getDocs(collection(db, "usuarios"));
      listaUsuarios = [];

      querySnapshot.forEach((doc) => {
        const user = doc.data();
        if (["vendedor", "supervisor", "gerente"].includes(user.rol)) {
          listaUsuarios.push({
            email: user.email,
            nombre: user.nombre,
            rol: user.rol
          });
        }
      });
    }

    // 📥 Cargar última cartera
    async function leerUltimaCartera() {
      const carpetaRef = ref(storage, 'sanvicenteauto/historial_cartera');
      const listado = await listAll(carpetaRef);

      if (listado.items.length === 0) {
        alert("No se encontró ninguna cartera.");
        return;
      }

      const ultimoArchivo = listado.items.sort((a, b) => b.name.localeCompare(a.name))[0];
      archivoOriginal = ultimoArchivo;
      const url = await getDownloadURL(ultimoArchivo);

      const response = await fetch(url);
      const data = await response.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const hoja = workbook.Sheets[workbook.SheetNames[0]];
      clientesOriginales = XLSX.utils.sheet_to_json(hoja);

      clientesSinVendedor = clientesOriginales.filter(c => !c.VENDEDOR || c.VENDEDOR.toString().trim() === "");
      renderizarTabla(clientesSinVendedor);
    }

    // 🖥️ Mostrar clientes
   function renderizarTabla(lista) {
   const tabla = document.querySelector("#tablaClientes tbody");
   tabla.innerHTML = "";

   lista.forEach((cliente, index) => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td><input type="checkbox" class="check-cliente" data-index="${index}"></td>
      <td>${cliente.NOMBRE_SUSCRIPTOR || "-"}</td>
      <td>${cliente.CONTRATO || "-"}</td>
      <td>${cliente.SUSCRIPCION || "-"}</td>
      <td>
        <select class="selector-usuario" data-index="${index}">
          <option value="">Seleccionar</option>
          ${listaUsuarios.map(u => `<option value="${u.email}">${u.nombre}</option>`).join("")}
        </select>
      </td>
    `;
    tabla.appendChild(fila);
  });
}

    // 💾 Guardar cambios
    async function actualizarCartera() {
      let asignaciones = {};
      let asignados = 0;
      let nombreAsignado = "";

      document.querySelectorAll(".check-cliente").forEach((checkbox) => {
        const index = checkbox.dataset.index;
        const selector = document.querySelector(`.selector-usuario[data-index="${index}"]`);
        const email = selector.value;

        if (checkbox.checked && email) {
          const cliente = clientesSinVendedor[index];
          cliente.VENDEDOR = email;
          asignados++;

          // guardar info para mensaje
          if (!asignaciones[email]) asignaciones[email] = 0;
          asignaciones[email]++;
        }
      });

      // Reemplazar los datos en el original
      clientesOriginales.forEach(cliente => {
        const modificado = clientesSinVendedor.find(c => c.SUSCRIPCION === cliente.SUSCRIPCION);
        if (modificado && modificado.VENDEDOR) {
          cliente.VENDEDOR = modificado.VENDEDOR;
        }
      });

      const nuevaHoja = XLSX.utils.json_to_sheet(clientesOriginales);
      const nuevoLibro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(nuevoLibro, nuevaHoja, "Hoja1");
      const excelBuffer = XLSX.write(nuevoLibro, { bookType: "xlsx", type: "array" });

      await uploadBytes(archivoOriginal, new Blob([excelBuffer]));

      // Mostrar mensaje final
      const mensaje = Object.entries(asignaciones)
        .map(([email, cantidad]) => `${cantidad} a ${email}`)
        .join(", ");

      document.getElementById("mensajeFinal").textContent = `Se asignaron ${asignados} clientes: ${mensaje}`;
      document.getElementById("mensajeFinal").style.display = "block";

      // Quitar los ya asignados
      await leerUltimaCartera();
    }

    // 🔍 Buscador
    document.getElementById('buscador').addEventListener('keyup', function () {
      const valor = this.value.toLowerCase();
      const filas = document.querySelectorAll("#tablaClientes tbody tr");

      filas.forEach(fila => {
        const nombre = fila.children[1].textContent.toLowerCase();
        const solicitud = fila.children[3].textContent.toLowerCase();
        fila.style.display = (nombre.includes(valor) || solicitud.includes(valor)) ? '' : 'none';
      });
    });
  </script>

</body>
</html>

