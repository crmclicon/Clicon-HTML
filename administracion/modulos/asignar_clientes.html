<script type="module">
  // 🔌 Importar módulos necesarios de Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getStorage, listAll, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

  // 🔐 Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
    authDomain: "clicon-oficial.firebaseapp.com",
    projectId: "clicon-oficial",
    storageBucket: "clicon-oficial.appspot.com",
    messagingSenderId: "604078149403",
    appId: "1:604078149403:web:5da069e8254c3695028dbe"
  };

  // 🚀 Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);

  // 🧠 Variables globales
  let listaUsuarios = [];  // Lista de usuarios Firestore
  let clientesSinVendedor = []; // Clientes filtrados

  // 🔁 Al cargar la página, inicia proceso
  window.addEventListener("DOMContentLoaded", async () => {
    await cargarUsuarios();
    await leerUltimaCartera();
  });

  // 📥 1. Obtener usuarios válidos desde Firestore
  async function cargarUsuarios() {
    const querySnapshot = await getDocs(collection(db, "usuarios"));
    listaUsuarios = [];

    querySnapshot.forEach((doc) => {
      const user = doc.data();
      if (["vendedor", "supervisor", "gerente"].includes(user.rol)) {
        listaUsuarios.push({
          email: user.email,
          nombre: user.nombre,
          rol: user.rol
        });
      }
    });
  }

  // 📦 2. Leer el archivo más reciente desde Storage
  async function leerUltimaCartera() {
    const carpetaRef = ref(storage, 'sanvicenteauto/historial_cartera');
    const listado = await listAll(carpetaRef);

    if (listado.items.length === 0) {
      alert("No se encontró ninguna cartera.");
      return;
    }

    // 📅 Buscar el archivo con nombre más reciente
    const ultimoArchivo = listado.items.sort((a, b) => b.name.localeCompare(a.name))[0];
    const url = await getDownloadURL(ultimoArchivo);

    // 🧾 Leer y procesar el archivo Excel
    const response = await fetch(url);
    const data = await response.arrayBuffer();
    const workbook = XLSX.read(data, { type: "array" });
    const hoja = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(hoja);

    // 🎯 Filtrar clientes sin VENDEDOR
    clientesSinVendedor = json.filter(c => !c.VENDEDOR || c.VENDEDOR.toString().trim() === "");

    // 🖥️ Mostrar en tabla
    renderizarTabla(clientesSinVendedor);
  }

  // 📊 3. Mostrar datos en HTML
  function renderizarTabla(lista) {
    const tabla = document.querySelector("#tablaClientes tbody");
    tabla.innerHTML = "";

    lista.forEach((cliente, index) => {
      const fila = document.createElement("tr");

      fila.innerHTML = `
        <td><input type="checkbox" class="check-cliente" data-index="${index}"></td>
        <td>${cliente.NOMBRE_SUSCRIPTOR || "-"}</td>
        <td>${cliente.CONTRATO || "-"}</td>
        <td>${cliente.SUSCRIPCION || "-"}</td>
        <td>
          <select class="selector-usuario" data-index="${index}">
            <option value="">Seleccionar</option>
            ${listaUsuarios.map(u => `<option value="${u.email}">${u.nombre} (${u.rol})</option>`).join("")}
          </select>
        </td>
      `;
      tabla.appendChild(fila);
    });
  }

</script>
