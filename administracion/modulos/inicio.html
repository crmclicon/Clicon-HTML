<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio</title>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      background-color: #F8FBFF;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      padding: 30px;
    }
    h2 {
      font-size: 26px;
      color: #3399FF;
      margin-bottom: 10px;
    }
    .estadisticas {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    canvas {
      width: 180px !important;
      height: 180px !important;
    }
    .placeholder {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 40px;
      color: #888;
      text-align: center;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 9999;
      width: 400px;
      max-width: 90%;
    }
    .modal h3 {
      margin-top: 0;
      color: #3399FF;
    }
    .modal button {
      margin-top: 10px;
      background: #3399FF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 9998;
    }
  </style>
</head>
<body>
  <h2>Inicio</h2>
  <input type="text" placeholder="Buscar por nombre, tel√©fono, G-O" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 24px;" />

  <div class="estadisticas">
    <div>
      <canvas id="activosChart"></canvas>
      <p style="text-align:center">Activos: <b id="activosCount">0</b></p>
    </div>
    <div>
      <canvas id="inactivosChart"></canvas>
      <p style="text-align:center">Inactivos: <b id="inactivosCount">0</b></p>
    </div>
    <div>
      <canvas id="moraChart"></canvas>
      <p style="text-align:center">En mora: <b id="moraCount">0</b></p>
    </div>
  </div>

  <div class="placeholder">
    üì¶ Ventas del mes en construcci√≥n...
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
      authDomain: "clicon-oficial.firebaseapp.com",
      projectId: "clicon-oficial",
      storageBucket: "clicon-oficial",
      messagingSenderId: "604078149403",
      appId: "1:604078149403:web:5da069e8254c3695028dbe"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    function porcentaje(valor, total) {
      return total === 0 ? 0 : Math.round((valor / total) * 100);
    }

    async function cargarDatos() {
      const carpetaRef = storage.ref("sanvicenteautomotores/historial_cartera");
      try {
        const lista = await carpetaRef.listAll();
        const archivos = lista.items;
        if (archivos.length === 0) return;

        const metadatas = await Promise.all(archivos.map(a => a.getMetadata()));
        const index = metadatas.reduce((max, m, i, arr) =>
          new Date(m.updated) > new Date(arr[max].updated) ? i : max, 0
        );
        const archivoURL = await archivos[index].getDownloadURL();

        const res = await fetch(archivoURL);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const datos = XLSX.utils.sheet_to_json(hoja);

        procesarEstadisticas(datos);
        window._clientes = datos;
      } catch (e) {
        console.error("Error al cargar datos:", e);
      }
    }

    function procesarEstadisticas(clientes) {
      let activos = 0, inactivos = 0, mora = 0;

      clientes.forEach(c => {
        const estado = (c.ESTADO_CONTRATO || "").trim().toUpperCase();
        const deuda = (c.NRO_CUOTAS_IMPAGAS || "").toString().trim();
        if (estado === "N0 - AHORRISTA") {
          activos++;
          if (deuda && deuda !== "0") mora++;
        } else if (["R0 - RENUNCIADO", "R2 - RESCINDIDO"].includes(estado)) {
          inactivos++;
        }
      });

      const total = clientes.length;

      document.getElementById("activosCount").textContent = activos;
      document.getElementById("inactivosCount").textContent = inactivos;
      document.getElementById("moraCount").textContent = mora;

      new Chart(document.getElementById("activosChart"), {
        type: "doughnut",
        data: {
          labels: ["Activos", "Otros"],
          datasets: [{
            data: [activos, total - activos],
            backgroundColor: ["#33cc33", "#eee"]
          }]
        },
        options: {
          cutout: "70%",
          plugins: {
            title: {
              display: true,
              text: `Activos: ${porcentaje(activos, total)}%`,
              position: 'bottom',
              font: { size: 14 }
            },
            legend: { display: false }
          }
        }
      });

      new Chart(document.getElementById("inactivosChart"), {
        type: "doughnut",
        data: {
          labels: ["Inactivos", "Otros"],
          datasets: [{
            data: [inactivos, total - inactivos],
            backgroundColor: ["#ff9900", "#eee"]
          }]
        },
        options: {
          cutout: "70%",
          plugins: {
            title: {
              display: true,
              text: `Inactivos: ${porcentaje(inactivos, total)}%`,
              position: 'bottom',
              font: { size: 14 }
            },
            legend: { display: false }
          }
        }
      });

      new Chart(document.getElementById("moraChart"), {
        type: "doughnut",
        data: {
          labels: ["En mora", "Sin mora"],
          datasets: [{
            data: [mora, activos - mora],
            backgroundColor: ["#9999FF", "#eee"]
          }]
        },
        options: {
          cutout: "70%",
          plugins: {
            title: {
              display: true,
              text: `En mora: ${porcentaje(mora, activos)}%`,
              position: 'bottom',
              font: { size: 14 }
            },
            legend: { display: false }
          }
        }
      });
    }

    window.onload = () => {
      const inputBuscar = document.querySelector("input[type='text']");
      inputBuscar.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          buscarCliente(inputBuscar.value.trim().toLowerCase());
        }
      });
    };

    function buscarCliente(valor) {
      if (!valor || !window._clientes) return;

      const resultados = window._clientes.filter(c =>
        (c.NOMBRE_SUSCRIPTOR || "").toLowerCase().includes(valor) ||
        (c.TELEFONO_SUSCRIPTOR || "").toString().includes(valor) ||
        (c.CONTRATO || "").toString().includes(valor)
      );

      if (resultados.length === 0) {
        alert("No se encontr√≥ ning√∫n cliente con ese dato.");
        return;
      }

      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      document.body.appendChild(overlay);

      const modal = document.createElement("div");
      modal.className = "modal";

      if (resultados.length === 1) {
        mostrarCliente(resultados[0], modal, overlay);
      } else {
        modal.innerHTML = `<h3>Coincidencias encontradas</h3>`;
        resultados.forEach((c, i) => {
          const nombre = c.NOMBRE_SUSCRIPTOR || `Sin nombre (${i + 1})`;
          const btn = document.createElement("button");
          btn.textContent = nombre;
          btn.style.display = "block";
          btn.style.margin = "10px 0";
          btn.onclick = () => {
            modal.remove();
            mostrarCliente(c, document.createElement("div"), overlay);
          };
          modal.appendChild(btn);
        });
        const cerrar = document.createElement("button");
        cerrar.textContent = "Cancelar";
        cerrar.onclick = () => {
          modal.remove();
          overlay.remove();
        };
        modal.appendChild(cerrar);
      }

      document.body.appendChild(modal);
    }

    function mostrarCliente(c, modal, overlay) {
      modal.className = "modal";
      modal.innerHTML = `
        <h3>Cliente encontrado</h3>
        <p><b>Nombre:</b> ${c.NOMBRE_SUSCRIPTOR || "?"}</p>
        <p><b>Tel√©fono:</b> ${c.TELEFONO_SUSCRIPTOR || "?"}</p>
        <p><b>G-O:</b> ${c.CONTRATO || "?"}</p>
        <p><b>Estado:</b> ${c.ESTADO_CONTRATO || "?"}</p>
        <p><b>Ctas pagas:</b> ${c.CANT_CUOTAS_PAGAS || "?"}</p>
        <p><b>Ctas emitidas:</b> ${c.CANT_CUOTAS_EMITIDAS || "?"}</p>
        <button id="cerrarModal">Cerrar</button>
      `;
      document.body.appendChild(modal);

      document.getElementById("cerrarModal").onclick = () => {
        modal.remove();
        overlay.remove();
      };
    }

    cargarDatos();
  </script>
</body>
</html>
