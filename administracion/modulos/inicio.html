<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio</title>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      background-color: #F8FBFF;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      padding: 30px;
    }
    h2 {
      font-size: 26px;
      color: #3399FF;
      margin-bottom: 10px;
    }
    .estadisticas {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    canvas {
      width: 180px !important;
      height: 180px !important;
    }
    .placeholder {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 40px;
      color: #888;
      text-align: center;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>Inicio</h2>
  <input type="text" placeholder="Buscar por nombre, telÃ©fono, grupo u orden" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 24px;" />

  <div class="estadisticas">
    <div>
      <canvas id="activosChart"></canvas>
      <p style="text-align:center">Activos: <b id="activosCount">0</b></p>
    </div>
    <div>
      <canvas id="inactivosChart"></canvas>
      <p style="text-align:center">Inactivos: <b id="inactivosCount">0</b></p>
    </div>
    <div>
      <canvas id="moraChart"></canvas>
      <p style="text-align:center">En mora: <b id="moraCount">0</b></p>
    </div>
  </div>

  <div class="placeholder">
    ðŸ“¦ Ventas del mes en construcciÃ³n...
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
      authDomain: "clicon-oficial.firebaseapp.com",
      projectId: "clicon-oficial",
      storageBucket: "clicon-oficial",
      messagingSenderId: "604078149403",
      appId: "1:604078149403:web:5da069e8254c3695028dbe"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    async function cargarDatos() {
      const carpetaRef = storage.ref("sanvicenteautomotores/historial_cartera");
      try {
        const lista = await carpetaRef.listAll();
        const archivos = lista.items;
        if (archivos.length === 0) return;

        const metadatas = await Promise.all(archivos.map(a => a.getMetadata()));
        const index = metadatas.reduce((max, m, i, arr) =>
          new Date(m.updated) > new Date(arr[max].updated) ? i : max, 0
        );
        const archivoURL = await archivos[index].getDownloadURL();

        const res = await fetch(archivoURL);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const datos = XLSX.utils.sheet_to_json(hoja);

        procesarEstadisticas(datos);
      } catch (e) {
        console.error("Error al cargar datos:", e);
      }
    }

    function procesarEstadisticas(clientes) {
      let activos = 0, inactivos = 0, mora = 0;

      clientes.forEach(c => {
        const estado = (c.ESTADO_CONTRATO || "").trim().toUpperCase();
        const deuda = (c.NRO_CUOTAS_IMPAGAS || "").toString().trim();
        if (estado === "N0") {
          activos++;
          if (deuda && deuda !== "0") mora++;
        } else if (estado === "R0" || estado === "R2") {
          inactivos++;
        }
      });

      document.getElementById("activosCount").textContent = activos;
      document.getElementById("inactivosCount").textContent = inactivos;
      document.getElementById("moraCount").textContent = mora;

      new Chart(document.getElementById("activosChart"), {
        type: "doughnut",
        data: {
          labels: ["Activos", ""],
          datasets: [{
            data: [activos, 1],
            backgroundColor: ["#33cc33", "#eee"]
          }]
        },
        options: { cutout: "70%" }
      });

      new Chart(document.getElementById("inactivosChart"), {
        type: "doughnut",
        data: {
          labels: ["Inactivos", ""],
          datasets: [{
            data: [inactivos, 1],
            backgroundColor: ["#ff9900", "#eee"]
          }]
        },
        options: { cutout: "70%" }
      });

      new Chart(document.getElementById("moraChart"), {
        type: "doughnut",
        data: {
          labels: ["En mora", ""],
          datasets: [{
            data: [mora, 1],
            backgroundColor: ["#9999FF", "#eee"]
          }]
        },
        options: { cutout: "70%" }
      });
    }

    cargarDatos();
  </script>
</body>
</html>
