<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mora</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getStorage,
      ref,
      getDownloadURL,
      listAll,
      getMetadata
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyDw4amrnoIcj1nvBeOlchzv5kBaD_sVSoE",
      authDomain: "clicon-oficial.firebaseapp.com",
      projectId: "clicon-oficial",
      storageBucket: "clicon-oficial",
      messagingSenderId: "604078149403",
      appId: "1:604078149403:web:5da069e8254c3695028dbe"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    async function cargarMoras() {
      const carpetaRef = ref(storage, "sanvicenteautomotores/historial_cartera");

      try {
        const listado = await listAll(carpetaRef);
        const archivos = listado.items;

        if (archivos.length === 0) throw new Error("No hay archivos en la carpeta");

        const metas = await Promise.all(archivos.map(a => getMetadata(a)));
        const indexMasReciente = metas.reduce((maxIdx, meta, idx, arr) => {
          return new Date(meta.updated) > new Date(arr[maxIdx].updated) ? idx : maxIdx;
        }, 0);

        const archivoMasReciente = archivos[indexMasReciente];
        const url = await getDownloadURL(archivoMasReciente);

        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const datos = XLSX.utils.sheet_to_json(hoja);

        const cuerpo = document.getElementById("tabla-mora");
        const contador = document.getElementById("contador-mora");
        cuerpo.innerHTML = "";

        let cantidad = 0;

        datos.forEach(cliente => {
          const estado = cliente.ESTADO_CONTRATO || "";
          const deuda = String(cliente.NRO_CUOTAS_IMPAGAS || "");

          if (estado === "N0 - Ahorrista" && deuda.trim() !== "") {
            cantidad++;
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${cliente.NOMBRE_SUSCRIPTOR || "-"}</td>
              <td>${cliente.VENDEDOR || "-"}</td>
              <td>${deuda}</td>
            `;
            cuerpo.appendChild(fila);
          }
        });

        contador.textContent = `Clientes en mora: ${cantidad}`;

      } catch (error) {
        console.error("Error al cargar la mora:", error);
        alert("No se pudo cargar la cartera.");
      }
    }

    window.onload = cargarMoras;
  </script>
  <style>
    body {
      background-color: #F8FBFF;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      padding: 40px;
    }
    h2 {
      font-size: 28px;
      color: #3399FF;
      margin-bottom: 10px;
    }
    #contador-mora {
      font-size: 16px;
      margin-bottom: 20px;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 15px;
    }
    th {
      background-color: #f1f7ff;
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>MORA</h2>
  <div id="contador-mora">Clientes en mora: 0</div>
  <table>
    <thead>
      <tr>
        <th>Nombre del cliente</th>
        <th>Vendedor</th>
        <th>Cuotas impagas</th>
      </tr>
    </thead>
    <tbody id="tabla-mora"></tbody>
  </table>
</body>
</html>
